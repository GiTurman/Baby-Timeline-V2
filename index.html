<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KIDDO - áƒªáƒ®áƒáƒ•áƒ áƒ”áƒ‘áƒ˜áƒ¡ áƒ¬áƒ˜áƒ’áƒœáƒ˜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #fdfaf3; color: #3d2b1f; }
        .book-card { background: white; border-radius: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.03); }
        .story-text::first-letter {
            float: left; font-size: 5rem; line-height: 0.8; padding-top: 8px;
            padding-right: 12px; font-weight: bold; color: #fb923c;
        }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #fb923c; width: 24px; height: 24px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-6 md:p-12">
    <div class="max-w-2xl mx-auto">
        <header class="text-center mb-16">
            <h1 class="text-5xl font-bold text-orange-950 mb-2">KIDDO</h1>
            <p class="text-orange-600 italic">áƒ©áƒ•áƒ”áƒœáƒ˜ áƒ“áƒ˜áƒ“áƒ˜ áƒ—áƒáƒ•áƒ’áƒáƒ“áƒáƒ¡áƒáƒ•áƒáƒšáƒ˜</p>
        </header>

        <div class="book-card p-10 mb-20 relative">
            <textarea id="userNote" class="w-full border-none focus:ring-0 text-2xl placeholder-orange-100 h-32 outline-none bg-transparent resize-none mb-6" placeholder="áƒáƒ¦áƒ¬áƒ”áƒ áƒ” áƒ“áƒ¦áƒ”áƒ•áƒáƒœáƒ“áƒ”áƒšáƒ˜ áƒ“áƒ¦áƒ”..."></textarea>
            
            <div id="imgPreviewContainer" class="hidden mb-8 relative">
                <button onclick="clearImg()" class="absolute top-2 right-2 bg-red-500 text-white w-8 h-8 rounded-full shadow-lg z-20 flex items-center justify-center font-bold">âœ•</button>
                <img id="previewImg" src="" class="w-full h-64 object-cover rounded-[30px] opacity-80">
            </div>

            <div class="flex flex-col gap-6">
                <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleFile(this)">
                <button onclick="document.getElementById('fileInput').click()" class="text-orange-800 font-bold border-b-2 border-orange-50 w-max pb-1">ğŸ–¼ï¸ áƒ¤áƒáƒ¢áƒáƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ</button>
                
                <button id="mainBtn" onclick="generateStory()" class="bg-gradient-to-r from-orange-400 to-pink-400 text-white font-bold py-6 rounded-[25px] shadow-2xl flex items-center justify-center gap-4">
                    <span id="btnText">áƒ©áƒáƒ¬áƒ”áƒ áƒ” áƒ¬áƒ˜áƒ’áƒœáƒ¨áƒ˜ âœ¨</span>
                    <div id="loader" class="loader"></div>
                </button>
            </div>
        </div>

        <div id="timeline" class="space-y-16"></div>
    </div>

    <script>
        const API_KEY = "AIzaSyDm5B64HwQ43WtoNiPEWluf0lDY75918HY";
        let currentImageData = null;

        function handleFile(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentImageData = e.target.result;
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imgPreviewContainer').classList.remove('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function clearImg() {
            currentImageData = null;
            document.getElementById('imgPreviewContainer').classList.add('hidden');
            document.getElementById('fileInput').value = "";
        }

        async function fetchAIResponse(modelName, prompt) {
            const url = `https://generativelanguage.googleapis.com/v1/models/${modelName}:generateContent?key=${API_KEY}`;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });
            if (!response.ok) throw new Error('API Error');
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        async function generateStory() {
            const note = document.getElementById('userNote').value;
            const btn = document.getElementById('mainBtn');
            const loader = document.getElementById('loader');
            const btnText = document.getElementById('btnText');

            if (!note) return alert("áƒ“áƒáƒ¬áƒ”áƒ áƒ” áƒ áƒáƒ›áƒ”...");

            btn.disabled = true;
            loader.style.display = "block";
            btnText.innerText = "KIDDO áƒ¤áƒ˜áƒ¥áƒ áƒáƒ‘áƒ¡...";

            const prompt = `áƒ¨áƒ”áƒœ áƒ®áƒáƒ  áƒ›áƒ¬áƒ”áƒ áƒáƒšáƒ˜. áƒ“áƒáƒ¬áƒ”áƒ áƒ” áƒ•áƒ áƒªáƒ”áƒšáƒ˜ (200 áƒ¡áƒ˜áƒ¢áƒ§áƒ•áƒ), áƒ”áƒ›áƒáƒªáƒ˜áƒ£áƒ áƒ˜ áƒ¬áƒ”áƒ áƒ˜áƒšáƒ˜ áƒ¨áƒ•áƒ˜áƒšáƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡ áƒáƒ› áƒ¤áƒ áƒáƒ–áƒáƒ–áƒ” áƒ“áƒáƒ§áƒ áƒ“áƒœáƒáƒ‘áƒ˜áƒ—: "${note}". áƒ”áƒœáƒ: áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜.`;

            try {
                let aiStory;
                try {
                    // áƒ¯áƒ”áƒ  áƒ•áƒªáƒ“áƒ˜áƒšáƒáƒ‘áƒ— Gemini 3-áƒ¡ (v1beta áƒ›áƒ˜áƒ¡áƒáƒ›áƒáƒ áƒ—áƒ˜áƒ—, áƒ áƒáƒ“áƒ’áƒáƒœ Preview áƒ˜áƒ¥áƒáƒ)
                    const v1betaUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${API_KEY}`;
                    const res = await fetch(v1betaUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await res.json();
                    aiStory = data.candidates[0].content.parts[0].text;
                } catch (err) {
                    console.log("Gemini 3 failed, using 1.5 Flash");
                    aiStory = await fetchAIResponse('gemini-1.5-flash', prompt);
                }

                addStoryToUI(aiStory, currentImageData);
                document.getElementById('userNote').value = "";
                clearImg();

            } catch (error) {
                alert("áƒ‘áƒáƒ“áƒ˜áƒ¨áƒ˜, áƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ˜ áƒ’áƒáƒ¬áƒ§áƒ“áƒ. áƒ¡áƒªáƒáƒ“áƒ” áƒ—áƒáƒ•áƒ˜áƒ“áƒáƒœ.");
            } finally {
                btn.disabled = false;
                loader.style.display = "none";
                btnText.innerText = "áƒ©áƒáƒ¬áƒ”áƒ áƒ” áƒ¬áƒ˜áƒ’áƒœáƒ¨áƒ˜ âœ¨";
            }
        }

        function addStoryToUI(story, img) {
            const timeline = document.getElementById('timeline');
            const date = new Date().toLocaleDateString('ka-GE', { day: 'numeric', month: 'long' });
            const html = `
                <div class="book-card p-10 border-l-[12px] border-orange-400">
                    <span class="text-orange-400 text-xs font-bold uppercase mb-4 block">${date}</span>
                    ${img ? `<img src="${img}" class="w-full h-80 object-cover rounded-[35px] mb-8">` : ''}
                    <div class="story-text text-orange-950 text-2xl leading-[1.8] font-serif italic whitespace-pre-line">${story}</div>
                </div>`;
            timeline.insertAdjacentHTML('afterbegin', html);
        }
    </script>
</body>
</html>
