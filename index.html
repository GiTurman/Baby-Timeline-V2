<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KIDDO - áƒªáƒ®áƒáƒ•áƒ áƒ”áƒ‘áƒ˜áƒ¡ áƒ¬áƒ˜áƒ’áƒœáƒ˜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // 1. áƒ©áƒáƒ¡áƒ•áƒ˜ áƒ¨áƒ”áƒœáƒ˜ Firebase Config áƒáƒ¥:
        const firebaseConfig = {
            apiKey: "AIza...", 
            authDomain: "...",
            projectId: "...",
            storageBucket: "...",
            messagingSenderId: "...",
            appId: "..."
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        window.generateStory = async () => {
            const note = document.getElementById('userNote').value;
            const btn = document.getElementById('mainBtn');
            const MY_API_KEY = "AIzaSyDm5B64HwQ43WtoNiPEWluf0lDY75918HY";

            if (!note) return alert("áƒ“áƒáƒ¬áƒ”áƒ áƒ” áƒ áƒáƒ˜áƒ›áƒ” áƒ›áƒáƒ›áƒ”áƒœáƒ¢áƒ˜...");

            btn.disabled = true;
            btn.innerText = "áƒ˜áƒ¬áƒ”áƒ áƒ”áƒ‘áƒ áƒ˜áƒ¡áƒ¢áƒáƒ áƒ˜áƒ...";

            try {
                // Gemini 3 Flash Preview - áƒ•áƒ—áƒ®áƒáƒ•áƒ— áƒ’áƒ áƒ«áƒ”áƒš áƒ“áƒ áƒ”áƒ›áƒáƒªáƒ˜áƒ£áƒ  áƒ¬áƒ”áƒ áƒ˜áƒšáƒ¡
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${"AIzaSyDm5B64HwQ43WtoNiPEWluf0lDY75918HY"}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `áƒ¨áƒ”áƒœ áƒ®áƒáƒ  áƒ›áƒ¬áƒ”áƒ áƒáƒšáƒ˜, áƒ áƒáƒ›áƒ”áƒšáƒ˜áƒª áƒ›áƒ¨áƒáƒ‘áƒšáƒ˜áƒ¡ áƒ¡áƒáƒ—áƒ¥áƒ›áƒ”áƒšáƒ¡ áƒáƒ§áƒáƒšáƒ˜áƒ‘áƒ”áƒ‘áƒ¡ áƒ¨áƒ•áƒ˜áƒšáƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡. áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ˜ áƒ›áƒáƒ’áƒªáƒ”áƒ›áƒ¡ áƒ›áƒáƒ™áƒšáƒ” áƒ¤áƒ áƒáƒ–áƒáƒ¡: "${note}". áƒ¨áƒ”áƒœáƒ˜ áƒáƒ›áƒáƒªáƒáƒœáƒáƒ áƒ“áƒáƒ¬áƒ”áƒ áƒ áƒ•áƒ áƒªáƒ”áƒšáƒ˜ (áƒ›áƒ˜áƒœáƒ˜áƒ›áƒ£áƒ› 150-200 áƒ¡áƒ˜áƒ¢áƒ§áƒ•áƒ), áƒ«áƒáƒšáƒ˜áƒáƒœ áƒ”áƒ›áƒáƒªáƒ˜áƒ£áƒ áƒ˜, áƒáƒáƒ”áƒ¢áƒ£áƒ áƒ˜ áƒ“áƒ áƒ—áƒ‘áƒ˜áƒšáƒ˜ áƒ¬áƒ”áƒ áƒ˜áƒšáƒ˜ áƒ¥áƒáƒ áƒ—áƒ£áƒš áƒ”áƒœáƒáƒ–áƒ”, áƒ áƒáƒ›áƒ”áƒšáƒ˜áƒª áƒ¬áƒšáƒ”áƒ‘áƒ˜áƒ¡ áƒ¨áƒ”áƒ›áƒ“áƒ”áƒ’ áƒ¨áƒ•áƒ˜áƒšáƒ›áƒ áƒ£áƒœáƒ“áƒ áƒ¬áƒáƒ˜áƒ™áƒ˜áƒ—áƒ®áƒáƒ¡. áƒ’áƒáƒ›áƒáƒ˜áƒ§áƒ”áƒœáƒ” áƒ›áƒ®áƒáƒ¢áƒ•áƒ áƒ£áƒšáƒ˜ áƒ”áƒœáƒ, áƒ˜áƒ¡áƒáƒ£áƒ‘áƒ áƒ” áƒ’áƒ áƒ«áƒœáƒáƒ‘áƒ”áƒ‘áƒ–áƒ” áƒ“áƒ áƒ˜áƒ›áƒáƒ–áƒ”, áƒ—áƒ£ áƒ áƒáƒ’áƒáƒ  áƒ¨áƒ”áƒªáƒ•áƒáƒšáƒ áƒáƒ› áƒ¬áƒáƒ›áƒ›áƒ áƒ¡áƒáƒ›áƒ§áƒáƒ áƒ.` }] }]
                    })
                });

                const data = await response.json();
                const storyText = data.candidates[0].content.parts[0].text;

                let imageUrl = "";
                if (window.selectedImg) {
                    const storageRef = ref(storage, 'stories/' + Date.now());
                    await uploadString(storageRef, window.selectedImg, 'data_url');
                    imageUrl = await getDownloadURL(storageRef);
                }

                // áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ”áƒ‘áƒ˜áƒ¡ áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ Firebase-áƒ¨áƒ˜
                await addDoc(collection(db, "stories"), {
                    original: note,
                    story: storyText,
                    image: imageUrl,
                    timestamp: Date.now()
                });

                document.getElementById('userNote').value = "";
                document.getElementById('imgPrev').style.display = "none";
                window.selectedImg = null;

            } catch (e) {
                console.error(e);
                alert("áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒáƒ, áƒ¡áƒªáƒáƒ“áƒ” áƒ›áƒáƒ’áƒ•áƒ˜áƒáƒœáƒ”áƒ‘áƒ˜áƒ—.");
            } finally {
                btn.disabled = false;
                btn.innerText = "áƒ©áƒáƒ¬áƒ”áƒ áƒ” áƒ¬áƒ˜áƒ’áƒœáƒ¨áƒ˜";
            }
        };

        // áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ”áƒ‘áƒ˜áƒ¡ áƒ áƒ”áƒáƒšáƒ£áƒ  áƒ“áƒ áƒáƒ¨áƒ˜ áƒ’áƒáƒ›áƒáƒ©áƒ”áƒœáƒ
        const q = query(collection(db, "stories"), orderBy("timestamp", "desc"));
        onSnapshot(q, (snapshot) => {
            const container = document.getElementById('timeline');
            container.innerHTML = "";
            snapshot.forEach((doc) => {
                const data = doc.data();
                const date = new Date(data.timestamp).toLocaleDateString('ka-GE');
                container.innerHTML += `
                    <div class="bg-white p-8 rounded-3xl shadow-sm mb-10 border border-orange-50 font-serif relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 text-orange-200 text-xs font-bold uppercase tracking-widest">${date}</div>
                        ${data.image ? `<img src="${data.image}" class="w-full h-80 object-cover rounded-2xl mb-6 shadow-md">` : ''}
                        <div class="text-orange-900 text-2xl leading-relaxed italic first-letter:text-5xl first-letter:font-bold first-letter:mr-3 first-letter:float-left">
                            ${data.story.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                `;
            });
        });
    </script>

    <style>
        body { background-color: #fdfaf3; color: #4a3728; }
        textarea { border: none; background: transparent; resize: none; width: 100%; height: 100px; font-size: 1.2rem; outline: none; }
        .book-input { background: white; border-radius: 25px; padding: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.03); }
    </style>
</head>
<body class="p-6 md:p-12">
    <div class="max-w-2xl mx-auto">
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold text-orange-950 mb-2">KIDDO</h1>
            <p class="text-orange-700 italic">áƒ©áƒ•áƒ”áƒœáƒ˜ áƒ“áƒ˜áƒ“áƒ˜ áƒ—áƒáƒ•áƒ’áƒáƒ“áƒáƒ¡áƒáƒ•áƒáƒšáƒ˜</p>
        </header>

        <div class="book-input mb-16 border-t-8 border-orange-300">
            <textarea id="userNote" placeholder="áƒáƒ¦áƒ¬áƒ”áƒ áƒ” áƒ”áƒ¡ áƒ¬áƒáƒ›áƒ˜ áƒ›áƒáƒ™áƒšáƒ”áƒ“..."></textarea>
            <div id="imgPrev" class="hidden mb-4"><img id="previewImage" class="w-full h-40 object-cover rounded-xl"></div>
            
            <div class="flex flex-col gap-4">
                <input type="file" id="fileInp" class="hidden" onchange="preview(this)">
                <button onclick="document.getElementById('fileInp').click()" class="text-orange-800 font-bold py-2 border-b-2 border-orange-100 self-start">ğŸ–¼ï¸ áƒ¤áƒáƒ¢áƒáƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ</button>
                <button id="mainBtn" onclick="generateStory()" class="bg-gradient-to-r from-orange-400 to-pink-400 text-white font-bold py-5 rounded-2xl shadow-xl hover:scale-105 transition">áƒ©áƒáƒ¬áƒ”áƒ áƒ” áƒ¬áƒ˜áƒ’áƒœáƒ¨áƒ˜</button>
            </div>
        </div>

        <div id="timeline" class="space-y-12"></div>
    </div>

    <script>
        function preview(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    window.selectedImg = e.target.result;
                    document.getElementById('previewImage').src = e.target.result;
                    document.getElementById('imgPrev').classList.remove('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
    </script>
</body>
</html>


